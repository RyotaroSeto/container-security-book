# 3章 コンテナへの主要な攻撃ルート

## 特権コンテナの危険性と攻撃例
- 特権コンテナ(Privileged Container)
  - 全てのケーパビリティが付与されているなど、通常のコンテナよりもホストとの分離が弱いコンテナ
  - Dockerコンテナの中でDockerデーモンを動かすDocker in Dockerやコンテナからハードウェアに直接アクセスする必要があるケースで利用される
  - runコマンドに`--privileged`オプションを付与することで特権コンテナを作成できる
  - Dockerにおける特権コンテナと通常コンテナの違いは以下
    - 全てのケーパビリティが付与される
    - sysfsなどのファイルシステムが書き込み可能でマウントされる
    - Seccompが無効になる
    - AppArmorのプロファイルが適用されない
    - 全てのデバイスファイルにアクセスできる

### [特権コンテナからホスト側にエスケープする方法 ](https://container-security.dev/security/breakout-to-host.html)
- cgroup release agentを使ったエスケープ
  - cgroup v1にはcgroupsで管理されているプロセスが存在しなくなった場合にカーネルに通知を送る機能がある
  - 通知を送る際にrelease agentプログラムと呼ばれる、ユーザーランドの任意のプログラムを実行できる
- uevent_helperを使ったエスケープ
  - ueventはデバイスが追加/削除された際に送信されるイベント
  - その際に/sys/kernel/uevent_helperに記載されているユーザーランドのプログラムを実行
- core_patternを使ったエスケープ
  - coredumpを生成する場合に/proc/sys/kernel/core_patternで出力するファイル名を変更できる
  - この時、ファイル名に`|`を含めることで、コマンドの実行が可能になる
- binfmt_miscを使ったエスケープ
  - binfmt_miscは指定したマジックナンバーや拡張子のファイルを実行する際に、指定のプログラムを実行できる仕組み

## DoS攻撃
- cgroupなどのリソースをコントロールする仕組みで、コンテナが使えるリソースを制限しなければ、コンテナからホストを巻き込むようなDoS攻撃が実行できてしまう
- 主な攻撃シナリオ
  - ユーザーのプログラムをコンテナで実行
  - ユーザーがコンテナ内で任意の操作をしたりすることができるようなサービス形態で発生
- ユーザーに悪意がない正規利用でも生じる可能性があるため、そのようなサービスを提供する場合、本項で紹介する設計にする必要あり

### Fork爆弾
- 高速に大量のプロセスを生成して、新しいプロセスの生成を困難にすることで、システムを正常に利用できないようにするDoS攻撃の一種
- コンテナはホストとカーネルを共有しているため、コンテナ内でFork爆弾を実行された場合、ホストにも影響及ぶ
- **Fork爆弾を防ぐにはcgroupsでプロセス数を制限する対策が有効**

### ディスク容量の圧迫
- コンテナに対してディスク容量の制限がされていない場合、大きなサイズのファイルを作成することで、ディスク容量を圧迫できる

- 他の攻撃として、メモリやCPUリソースを大量に使用するDoS攻撃もある
- **これらの攻撃を防ぐためのcgroupsの活用は第5章参照**

## センシティブなファイルのマウント
- コンテナにホストのファイルやディレクトリをマウントすることで、コンテナからそのファイルやディレクトリを読み書きできる
- この時、そのファイルを利用してエスケープできることがある

### /var/run/docker.sockのマウント
- コンテナがホストのファイルを必要とするケースの1つにDocker outside of Docker(DooD)がある
- DooD
  - Dockerコンテナの中から外部のDockerコンテナを操作すること
  - ホストのDockerソケットをバインドマウントした状態を指す。これにより、コンテナからホスト側のDockerを操作できるようになる
  - CI上でのコンテナイメージビルドなどで便利
    - ホスト側のDockerを操作できてしまうということは、ホストにエスケープできてしまう

### procfsとsysfsのマウント
- procfsやsysfsはカーネルパラメータを設定できる機能や機微な情報が提供されている
- これらのディレクトリをコンテナにマウントしている場合、ホスト側へのエスケープにつながる
- そのため多くのコンテナランタイムは特定のファイルはread-onlyもしくは/dev/nullとしてマウントされている
|  ファイル  |  概要  |
| ---- | ---- |
|  /proc/sys/kernel/core_pattern  |  coreファイルの名前を指定できる。パイプが利用できるため、ホスト側での任しコード実行に繋げることが可能  |
|  /proc/sys/fs/bitfmt_misc  |  指定した拡張子やマジックナンバーを持つファイルを実行する際のインタプリンタを指定できる。コンテナ内のファイルを指定することで、ホスト側で対応したファイル実行時にエスケープにつながる  |
|  /proc/sysrq-trigger  |  SysRqコマンドを扱うファイル。例えば、コンテナから文字列cをこのファイルに書き込むことでホストにカーネルパニックを起こせる  |
|  /proc/sched_debug  |  プロセスのスケジュール管理情報を持っているファイル。全てのNameSpacesのプロセス名が含まれるため、ホストのプロセスも確認できる  |
|  /proc/kcore  |  メモリの状態をELF形式で保持しているファイル。メモリの内容をダンプできる  |
|  /sys/kernel/uevent_helper  |  ueventが発生した際に実行するプログラムを指定できる。コンテナでueventを発生させることで、ホスト側での任意コードを実行に繋げることが可能  |
|  /sys/kernel/vmcoreinfo  |  カーネルのアドレスリークにつながる  |

## Linuxカーネルへの攻撃
