## 3章 コンテナへの主要な攻撃ルート

### 特権コンテナの危険性と攻撃例
- 特権コンテナ(Privileged Container)
  - 全てのケーパビリティが付与されているなど、通常のコンテナよりもホストとの分離が弱いコンテナ
  - Dockerコンテナの中でDockerデーモンを動かすDocker in Dockerやコンテナからハードウェアに直接アクセスする必要があるケースで利用される
  - runコマンドに`--privileged`オプションを付与することで特権コンテナを作成できる
  - Dockerにおける特権コンテナと通常コンテナの違いは以下
    - 全てのケーパビリティが付与される
    - sysfsなどのファイルシステムが書き込み可能でマウントされる
    - Seccompが無効になる
    - AppArmorのプロファイルが適用されない
    - 全てのデバイスファイルにアクセスできる

### [特権コンテナからホスト側にエスケープする方法 ](https://container-security.dev/security/breakout-to-host.html)
- cgroup release agentを使ったエスケープ
  - cgroup v1にはcgroupsで管理されているプロセスが存在しなくなった場合にカーネルに通知を送る機能がある
  - 通知を送る際にrelease agentプログラムと呼ばれる、ユーザーランドの任意のプログラムを実行できる
- uevent_helperを使ったエスケープ
  - ueventはデバイスが追加/削除された際に送信されるイベント
  - その際に/sys/kernel/uevent_helperに記載されているユーザーランドのプログラムを実行
- core_patternを使ったエスケープ
  - coredumpを生成する場合に/proc/sys/kernel/core_patternで出力するファイル名を変更できる
  - この時、ファイル名に`|`を含めることで、コマンドの実行が可能になる
- binfmt_miscを使ったエスケープ
  - binfmt_miscは指定したマジックナンバーや拡張子のファイルを実行する際に、指定のプログラムを実行できる仕組み

### DoS攻撃
- cgroupなどのリソースをコントロールする仕組みで、コンテナが使えるリソースを制限しなければ、コンテナからホストを巻き込むようなDoS攻撃が実行できてしまう
- 主な攻撃シナリオ
  - ユーザーのプログラムをコンテナで実行
  - ユーザーがコンテナ内で任意の操作をしたりすることができるようなサービス形態で発生
- ユーザーに悪意がない正規利用でも生じる可能性があるため、そのようなサービスを提供する場合、本項で紹介する設計にする必要あり

### Fork爆弾
