# 第6章 セキュアなコンテナ環境の高知機

## 6.1 コンテナのセキュリティ監視
コンテナ自体の関連するログやイベントの監視も重要だが、ホスト側のセキュリティモニタリングも大切

### 監視対象を整理する
- どのようなシステムであっても全てのログを取得・監視できれば理想だが、それは金銭・運用コストなどから非常に難しい
- そのため、何を監視すべきか整理することが重要

| 攻撃例 | 監視対象 |
| ---- | ---- |
| Docker APIへのアクセス | Docker APIへのアクセスログの監視、Dockerのイベント監視 |
| アプリケーションへの攻撃 | アプリケーションログの監視 |
| ホスト側へのエスケープ | 実行されるコンテナ設定の監視、コンテナ内で実行されるコマンドの監視 |
| 悪意あるイメージの使用 | Dockerのイベント監視 |

- 他にも以下のような場合、防止することが望ましい
  - 無効な、または予期せぬプロセスの実行
  - 無効な、または予期せぬシステムコール
  - 保護された設定ファイルとバイナリの変更
  - 予期せぬ場所やファイルタイプへの書き込み
  - 予期せぬネットワークリスナーの作成
  - 予期せぬネットワークの宛先に送信されたトラフィック
  - マルウェアの保存または実行

- しかし難しいのはこれらの監視をどのようなルールで監視するかである。
  - どのようなイベントが発生して、監視が適切にできているかテストをするなど

### コンテナのセキュリティ監視で利用されるソフトウェアの紹介
- [Sysdig](https://github.com/draios/sysdig)
  - 製品もあるが、OSSもある。
  - プロセスのシステムコールの呼び出しなどをトレースし、ファイルのオープンやコマンドの実行などさまざまなイベントを表示・保存できる
  - sysdigは引数にフィルタを与えることで、イベントをフィルタリングできる。フィルタの条件は、比較演算子やブール演算子を括弧と組み合わせて使用できる
  - 以下は「プロセス名がcatもしくはviの場合でかつ、openatシステムコールが呼ばれた」場合のフィルタ
    - `sudo sysdig '(proc.name = cat or proc.name = vi) and evt.type = openat'`
  - またキャプチャしたイベントをファイルとして保存できる機能がある。-w ファイル名でファイルを保存し、-rで読み込むことができる
    - `sudo sysdig -w capture.scap`
    - `sudo sysdig -r capture.scap`
- [Falco](https://github.com/falcosecurity/falco)
  - OSSのコンテナ向けセキュリティモニタリングソフトウェア。もともとsysdigで開発されていたが、現在はCNCF傘下
  - セキュリティイベントを検知するためのルールを定義でき、ルールに一致するとアラートとして記録する
- Fluentd / Fluent Bit
  - コンテナのログやFalcoのアラートなどは、保全や検索などを目的として、外部ストレージや外部サービスに転送を検討すべき。
  - ログやアラートを外部へ転送するソフトウェア。
  - 例えばS3やElasticsearchなどへ転送できる

### コンテナのログ収集の設計

**Dockerのロギングドライバを利用する**
- Dockerはデフォルトで、コンテナの標準出力と標準エラー出力を/var/lib/docker/containers配下に出力する
- `docker run --rm -d --name nginx nginx:latest`
- `docker inspect nginx | jq -r .[].LogPath`
- 感覚としてはDocker → Fluentd → S3 という感じでログを転送する

**ログ収集ソフトウェアをホスト側で動かす**
- Fluentd / Fluent Bitなどのログ収集ソフトウェアをホスト側でデーモンとして動作させて、コンテナのログを収集する方法
- 感覚としてPodのサイドカーとしてFluentdがいてそのまま → S3 みたいな感じ?
 
## 6.2 コンテナの操作ログの記録
