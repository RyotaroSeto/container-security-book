# 第6章 セキュアなコンテナ環境の高知機

## 6.1 コンテナのセキュリティ監視
コンテナ自体の関連するログやイベントの監視も重要だが、ホスト側のセキュリティモニタリングも大切

### 監視対象を整理する
- どのようなシステムであっても全てのログを取得・監視できれば理想だが、それは金銭・運用コストなどから非常に難しい
- そのため、何を監視すべきか整理することが重要

| 攻撃例 | 監視対象 |
| ---- | ---- |
| Docker APIへのアクセス | Docker APIへのアクセスログの監視、Dockerのイベント監視 |
| アプリケーションへの攻撃 | アプリケーションログの監視 |
| ホスト側へのエスケープ | 実行されるコンテナ設定の監視、コンテナ内で実行されるコマンドの監視 |
| 悪意あるイメージの使用 | Dockerのイベント監視 |

- 他にも以下のような場合、防止することが望ましい
  - 無効な、または予期せぬプロセスの実行
  - 無効な、または予期せぬシステムコール
  - 保護された設定ファイルとバイナリの変更
  - 予期せぬ場所やファイルタイプへの書き込み
  - 予期せぬネットワークリスナーの作成
  - 予期せぬネットワークの宛先に送信されたトラフィック
  - マルウェアの保存または実行

- しかし難しいのはこれらの監視をどのようなルールで監視するかである。
  - どのようなイベントが発生して、監視が適切にできているかテストをするなど

### コンテナのセキュリティ監視で利用されるソフトウェアの紹介
- [Sysdig](https://github.com/draios/sysdig)
  - 製品もあるが、OSSもある。
  - プロセスのシステムコールの呼び出しなどをトレースし、ファイルのオープンやコマンドの実行などさまざまなイベントを表示・保存できる
  - sysdigは引数にフィルタを与えることで、イベントをフィルタリングできる。フィルタの条件は、比較演算子やブール演算子を括弧と組み合わせて使用できる
  - 以下は「プロセス名がcatもしくはviの場合でかつ、openatシステムコールが呼ばれた」場合のフィルタ
    - `sudo sysdig '(proc.name = cat or proc.name = vi) and evt.type = openat'`
  - またキャプチャしたイベントをファイルとして保存できる機能がある。-w ファイル名でファイルを保存し、-rで読み込むことができる
    - `sudo sysdig -w capture.scap`
    - `sudo sysdig -r capture.scap`
- [Falco](https://github.com/falcosecurity/falco)
  - OSSのコンテナ向けセキュリティモニタリングソフトウェア。もともとsysdigで開発されていたが、現在はCNCF傘下
  - セキュリティイベントを検知するためのルールを定義でき、ルールに一致するとアラートとして記録する
- Fluentd / Fluent Bit
  - コンテナのログやFalcoのアラートなどは、保全や検索などを目的として、外部ストレージや外部サービスに転送を検討すべき。
  - ログやアラートを外部へ転送するソフトウェア。
  - 例えばS3やElasticsearchなどへ転送できる

### コンテナのログ収集の設計

**Dockerのロギングドライバを利用する**
- Dockerはデフォルトで、コンテナの標準出力と標準エラー出力を/var/lib/docker/containers配下に出力する
- `docker run --rm -d --name nginx nginx:latest`
- `docker inspect nginx | jq -r .[].LogPath`
- 感覚としてはDocker → Fluentd → S3 という感じでログを転送する

**ログ収集ソフトウェアをホスト側で動かす**
- Fluentd / Fluent Bitなどのログ収集ソフトウェアをホスト側でデーモンとして動作させて、コンテナのログを収集する方法
- 感覚としてPodのサイドカーとしてFluentdがいてそのまま → S3 みたいな感じ?
 
## 6.2 コンテナの操作ログの記録

## 6.3 Sysdig / Falcoによるコンテナの挙動監視
- コンテナの侵害を検知するには、コンテナ内で実行されたコマンドやファイルの変更、ネットワークアクセスを監視する必要がある。
- 攻撃者が権限昇格を行う可能性もあるため、エスケープが可能な特権コンテナやホスト側のファイルをマウントするコンテナも検知した方がよい
- Sysdig / Falcoを使った以下6つの項目を検知する方法
  - 無効な、または予期せぬプロセスの実行
    - `execve`システムコールなどのシステムコールを監視することで実現可能
    - また、Falcoのデフォルトルールには不審なコマンドが実行された場合検知するルールがある
  - 無効な、または予期せぬシステムコール
    - コンテナ内で発生したシステムコールをトレースするには以下のようにSysdigを使用
      - `sysdig -pc 'container.id != host and evt.dir = <'`
      - ただし全てのシステムコールをトレースするとログが膨大になるため、「アプリケーションが実行するシステムコールを定義し、それ以外のシステムコールが実行された場合検知する」
  - 予期せぬファイルへの書き込み
    - コンテナ内でのファイルへの書き込みを検知するには以下のようにSysdigを使用
      - `sysdig -pc 'container.id != host and evt.is_open_write = true'`
  - 予期せぬネットワークリスナーの作成(攻撃者はサーバーを侵害した際にバックドアとして、外部から接続できるようなサービスを起動することがある。その侵害を受けたことを検知するためにネットワークリスナーの作成を監視する)
    - listenシステムコールなどの呼び出しをフィルタすることで検知可能
      - `sysdig -pc 'container.id != host and evt.type = listen and evt.dir = >'`
    - また実際に接続があったことも確認したい場合は`accept`システムコールなどの呼び出しも条件に追加することで検知可能
      - `sysdig -pc 'container.id != host and evt.type in (accept,listen) and evt.dir = >'`
    - ネットワークリスナーの作成や外部からの接続が意図したものである場合、接続される側のポート番号が含まれる`fd.sport`フィールドでフィルタすると良い
      - `sysdig -pc 'container.id != host and evt.type in (accept,listen) and evt.dir = > and fd.sport != 80'`
  - 予期せぬネットワークの宛先に送信されたトラフィック
    - 攻撃者はサーバー侵入後、サーバー内のファイルや環境変数などを外部に送信したり、横展開のために他マシンへ接続することがある。この場合は、意図しないネットワークに接続していないか監視することで検知可能
    - Sysdigでは`connect`システムコールをフィルタすることで、ネットワーク接続を検知できる。`fd.connected = true`をフィルタに追加することで、実際にコネクションが接続した場合だけに限定できる
      - `sysdig -pc 'container.id != host and evt.type = connect and fd.connected = true and not fd.sip.name in (example.com) and not fd.sip in (8.8.8.8)'`
  - セキュアでないコンテナランタイムの設定（特権コンテナの検知）
    - 特権コンテナはホストとの分離が非常に弱いため、容易にエスケープできる。攻撃者がコンテナを作成できる権限を取得している場合、特権コンテナを作成してエスケープする可能性あり
    - 以下は特権コンテナの起動を検知
      - `sysdig -pc 'evt.type = container and container.privileged = true'`
- **Sysdig / Falcoのバイパス（回避）**
  - シンボリックリンクを使ったバイパス
    - バイナリが配置されているディレクトリ配下への書き込みルールは、ディレクトリが/bin,/sbin,/usr/bin,/usr/sbinの場合に検知する条件。しかしシンボリックリンクを使うことでこのルールに検知されることなく書き込める
    - シンボリックリンクの作成自体は`create_symlink`マクロで検知できる

## 6.4 ホストのファイル整合性監視
エスケープされたり、ホスト側に侵入されたりした場合に備え、コンテナを動かしているホスト側の監視も重要。DockerのCIS Benchmarkではファイルの整合性監視として次のファイルやディレクトリが挙げられる
- docker.service
- containerd.sock
- docker.sock
- /run/containerd
- /var/lib/docker
- /etc/docker
- /etc/default/docker
- /etc/docker/daemon.json ...

- これらのファイルの整合性監視を`auditd`を用いて行う
- /etc/dockerと/usr/bin配下のファイル監視するために、以下のような設定を/etc/audit/rules.d/docker.rulesファイルとして作成する
```
-w /etc/docker -p wa -k etc-docker
-w /usr/bin -p wa -k usr-bin
```

## 6.5 その他セキュリティモニタリング
- アプリケーションログの監視
  - コンテナで動いているアプリケーションの脆弱性を悪用される可能性もあるため、コンテナのログを収集しておく
- イメージレジストリの監視
  - 管理しているイメージの改ざんに気づくためにも、レジストリ側でPushのログなどを確認できるようにしておくとよい。
  - レジストリの監視以外にも、レジストリの死活監視をしたり、レジストリを複数利用することで障害を回避しても良い
- リソースの監視
  - 攻撃を受けると、CPUやメモリの使用率、外部への通信量が増えることがあるため、リソースの使用状況を監視することは攻撃の検知につながる
  - 実際の運用ではcAdvisor,Mackerel,Datafogなどを使って、リソースの使用状況を確認すると良い
 
## 6.6 コンテナの攻撃や設定ミスを防ぐ

### opa-docker-authzプラグインを使ってコンテナの設定を強制する
- このプラグインを使用することで、特権コンテナのような特定の設定で構成されたコンテナの作成を拒否できる
- 特権コンテナの作成を禁止するポリシーを定義できる

### Docker Bench for Securityで設定を継続的に監査する
- ホストやDockerランタイム自体が適切に構成されているか継続的に監査しておくことも重要
- シェルスクリプトのためクローンし、docker-bench-security.shを実行するだけで監査できる

### SIEMやSOARとの連携
- ログを収集して通知する基盤
- 有名なSIEM実装として、Elasticsearch + Logstach + Kibana や　Splunkがある
- また明らかにインシデントと判断できるアラートで、対応を自動化できる場合はSOARと連携も検討するとよい。インシデント対応の自動化や管理を行うための仕組み 
